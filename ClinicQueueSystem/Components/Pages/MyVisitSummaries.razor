@page "/my/visit-notes"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using ClinicQueueSystem.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthorizationService AuthService
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@attribute [Authorize]

<PageTitle>My Visit Notes - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (patient == null)
    {
        <div class="alert alert-warning">
            We could not find your patient profile.
        </div>
    }
    else
    {
        <div class="card mb-4">
            <div class="card-header" style="background-color: #2C5F8D; color: white;">
                <h3 class="card-title mb-0">My Visit Notes</h3>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap align-items-end gap-2">
                    <div>
                        <label class="form-label mb-1">From</label>
                        <InputDate @bind-Value="filterFrom" class="form-control form-control-sm" />
                    </div>
                    <div>
                        <label class="form-label mb-1">To</label>
                        <InputDate @bind-Value="filterTo" class="form-control form-control-sm" />
                    </div>
                    <div class="flex-grow-1">
                        <label class="form-label mb-1">Search</label>
                        <input class="form-control form-control-sm" placeholder="Search notes..." @bind="searchText" @bind:event="oninput" />
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" @onclick="ApplyFilters">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        @if (filteredVisits?.Any() != true)
        {
            <div class="alert alert-info">No visit notes found.</div>
        }
        else
        {
            <div class="list-group">
                @foreach (var v in filteredVisits)
                {
                    var isOpen = expanded.Contains(v.Id);
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div><strong>@v.StartTime.ToLocalTime().ToString("MMM dd, yyyy h:mm tt")</strong> â€” @v.Status</div>
                                @if (!string.IsNullOrEmpty(v.Diagnosis))
                                {
                                    <small class="text-muted">Dx: @v.Diagnosis</small>
                                }
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => Toggle(v.Id)">
                                @(isOpen ? "Hide" : "View")
                            </button>
                        </div>
                        @if (isOpen)
                        {
                            <div class="mt-3">
                                @if (v.Notes?.Any() == true)
                                {
                                    @foreach (var n in v.Notes.OrderByDescending(n => n.CreatedAt))
                                    {
                                        <div class="mb-3 p-2 border rounded">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong>@n.NoteType</strong>
                                                </div>
                                                <small class="text-muted">@n.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy h:mm tt")</small>
                                            </div>
                                            <div class="mt-2" style="white-space: pre-wrap;">@n.NoteText</div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="text-muted">No notes recorded for this visit.</div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private bool loading = true;
    private bool isPatient = false;
    private Patient? patient;
    private List<Visit> visits = new();
    private List<Visit> filteredVisits = new();
    private HashSet<int> expanded = new();

    private DateTime? filterFrom = null;
    private DateTime? filterTo = null;
    private string searchText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        isPatient = await AuthService.IsPatientAsync();
        if (!isPatient)
        {
            loading = false;
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user == null)
        {
            loading = false;
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();
        patient = await db.Patients.FirstOrDefaultAsync(p => p.UserId == user.Id);
        if (patient != null)
        {
            visits = await db.Visits
                .Where(v => v.PatientId == patient.Id)
                .Include(v => v.Notes)
                .OrderByDescending(v => v.StartTime)
                .ToListAsync();
            ApplyFilters();
        }

        loading = false;
    }

    private void ApplyFilters()
    {
        IEnumerable<Visit> q = visits;
        if (filterFrom.HasValue)
        {
            q = q.Where(v => v.StartTime.Date >= filterFrom.Value.Date);
        }
        if (filterTo.HasValue)
        {
            q = q.Where(v => v.StartTime.Date <= filterTo.Value.Date);
        }
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var s = searchText.Trim();
            q = q.Where(v => v.Notes.Any(n => 
                (n.NoteText != null && n.NoteText.Contains(s, StringComparison.OrdinalIgnoreCase)) || 
                (n.NoteType != null && n.NoteType.Contains(s, StringComparison.OrdinalIgnoreCase))));
        }
        filteredVisits = q.OrderByDescending(v => v.StartTime).ToList();
    }

    private void Toggle(int id)
    {
        if (expanded.Contains(id)) expanded.Remove(id);
        else expanded.Add(id);
    }
}


