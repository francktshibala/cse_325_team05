@page "/providers/create"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<PageTitle>Create Provider - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    <div class="card">
        <div class="card-header" style="background-color: #2C5F8D; color: white;">
            <h5 class="mb-0">Create Provider</h5>
        </div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            <EditForm Model="model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">User</label>
                        <select class="form-control" @bind="selectedUserId">
                            <option value="">Select a userâ€¦</option>
                            @foreach (var u in availableUsers)
                            {
                                <option value="@u.Id">@u.FirstName @u.LastName (@u.UserName)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Provider Type</label>
                        <select class="form-control" @bind="model.ProviderType">
                            <option>Doctor</option>
                            <option>Nurse</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-control" @bind="model.IsActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Specialty</label>
                        <input class="form-control" @bind="model.Specialty" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">License Number</label>
                        <input class="form-control" @bind="model.LicenseNumber" />
                    </div>
                </div>
                <div class="mt-4 d-flex gap-2">
                    <button class="btn btn-primary" type="submit" disabled="@saving">Create</button>
                    <a class="btn btn-secondary" href="/providers">Cancel</a>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private Provider model = new();
    private List<ApplicationUser> availableUsers = new();
    private string selectedUserId = "";
    private bool saving = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        // Load users who are not already providers
        var existingProviderUserIds = await db.Providers.Select(p => p.UserId).ToListAsync();
        availableUsers = await db.Users
            .Where(u => !existingProviderUserIds.Contains(u.Id))
            .OrderBy(u => u.LastName).ThenBy(u => u.FirstName)
            .ToListAsync();
        model.ProviderType = "Doctor";
        model.IsActive = true;
    }

    private async Task HandleSubmit()
    {
        errorMessage = "";
        if (string.IsNullOrEmpty(selectedUserId))
        {
            errorMessage = "Please select a user.";
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        var exists = await db.Providers.AnyAsync(p => p.UserId == selectedUserId);
        if (exists)
        {
            errorMessage = "Selected user is already a provider.";
            return;
        }
        model.UserId = selectedUserId;
        saving = true;
        try
        {
            db.Providers.Add(model);
            await db.SaveChangesAsync();
            Navigation.NavigateTo("/providers");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create provider: {ex.Message}";
            saving = false;
        }
    }
}
