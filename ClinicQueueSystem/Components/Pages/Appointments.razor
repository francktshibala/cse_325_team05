@page "/appointments"
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using ClinicQueueSystem.Services
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject ApplicationDbContext DbContext
@inject AuthorizationService AuthService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Appointments - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 style="color: #2C5F8D; font-weight: 700;">Appointments</h1>
            <p class="text-muted">View and manage your appointments</p>
            <a href="/appointments/availability" class="btn btn-outline-primary btn-sm">Find Availability</a>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (appointments == null || !appointments.Any())
    {
        <div class="row">
            <div class="col-md-12">
                <div class="card" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); padding: 3rem;">
                    <div class="text-center">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“…</div>
                        <h3 style="color: #495057; margin-bottom: 1rem;">No Appointments Found</h3>
                        <p style="color: #6c757d; font-size: 1.125rem; margin-bottom: 2rem;">
                            @if (isPatient)
                            {
                                <text>You don't have any appointments scheduled yet. Book your first appointment to get started!</text>
                            }
                            else
                            {
                                <text>There are no appointments in the system at this time.</text>
                            }
                        </p>
                        @if (canBookAppointments)
                        {
                            <a href="/appointments/book" class="btn btn-primary btn-lg">Book New Appointment</a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-3">
            <div class="col-md-12 d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-primary">Total: @appointments.Count()</span>
                    @if (canBookAppointments)
                    {
                        <a href="/appointments/book" class="btn btn-primary btn-sm ms-2">Book New Appointment</a>
                    }
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var appointment in appointments.OrderBy(a => a.ScheduledDateTime))
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100" style="border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0" style="color: #2C5F8D;">
                                    @appointment.AppointmentType
                                </h5>
                                <span class="badge @GetStatusBadgeClass(appointment.Status)">
                                    @appointment.Status
                                </span>
                            </div>
                            
                            <div class="mb-2">
                                <strong>Date & Time:</strong><br />
                                <span style="color: #495057;">
                                    @appointment.ScheduledDateTime.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                </span>
                            </div>
                            
                            <div class="mb-2">
                                <strong>Duration:</strong> @appointment.DurationMinutes minutes
                            </div>
                            
                            @if (!isPatient)
                            {
                                <div class="mb-2">
                                    <strong>Patient:</strong><br />
                                    <span style="color: #495057;">
                                        @appointment.Patient.User.FirstName @appointment.Patient.User.LastName
                                    </span>
                                </div>
                            }
                            
                            @if (appointment.Provider != null)
                            {
                                <div class="mb-2">
                                    <strong>Provider:</strong><br />
                                    <span style="color: #495057;">
                                        @appointment.Provider.User.FirstName @appointment.Provider.User.LastName
                                        @if (!string.IsNullOrEmpty(appointment.Provider.Specialty))
                                        {
                                            <text> - @appointment.Provider.Specialty</text>
                                        }
                                    </span>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(appointment.Reason))
                            {
                                <div class="mb-2">
                                    <strong>Reason:</strong><br />
                                    <span style="color: #6c757d;">@appointment.Reason</span>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(appointment.Notes))
                            {
                                <div class="mb-2">
                                    <strong>Notes:</strong><br />
                                    <span style="color: #6c757d; font-size: 0.9rem;">@appointment.Notes</span>
                                </div>
                            }
                        </div>
                        
                        @if (canManageAppointments || (isPatient && appointment.Status == "Scheduled"))
                        {
                            <div class="card-footer bg-transparent border-top">
                                <div class="btn-group w-100" role="group">
                                    @if (canManageAppointments)
                                    {
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => EditAppointment(appointment.Id)">
                                            Edit
                                        </button>
                                    }
                                    @if (canCancelAppointments && appointment.Status != "Cancelled" && appointment.Status != "Completed")
                                    {
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => CancelAppointment(appointment.Id)">
                                            Cancel
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Appointment>? appointments;
    private bool loading = true;
    private ApplicationUser? currentUser;
    private bool isPatient = false;
    private bool canBookAppointments = false;
    private bool canManageAppointments = false;
    private bool canCancelAppointments = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUser = await UserManager.GetUserAsync(authState.User);
        
        if (currentUser == null)
        {
            loading = false;
            return;
        }

        // Pre-compute permission checks
        isPatient = await AuthService.IsPatientAsync();
        canBookAppointments = await AuthService.HasPermissionAsync(Permissions.Appointments_Book);
        canManageAppointments = await AuthService.HasPermissionAsync(Permissions.Appointments_Manage);
        canCancelAppointments = await AuthService.HasPermissionAsync(Permissions.Appointments_Cancel);

        await LoadAppointments();
        loading = false;
    }

    private async Task LoadAppointments()
    {
        var query = DbContext.Appointments
            .Include(a => a.Patient)
                .ThenInclude(p => p.User)
            .Include(a => a.Provider)
                .ThenInclude(p => p.User)
            .AsQueryable();

        // Filter based on role
        if (isPatient)
        {
            // Patients see only their own appointments
            var patient = await DbContext.Patients
                .FirstOrDefaultAsync(p => p.UserId == currentUser!.Id);
            
            if (patient != null)
            {
                query = query.Where(a => a.PatientId == patient.Id);
            }
            else
            {
                appointments = new List<Appointment>();
                return;
            }
        }
        else if (await AuthService.IsDoctorAsync())
        {
            // Doctors see appointments for their patients
            var provider = await DbContext.Providers
                .FirstOrDefaultAsync(p => p.UserId == currentUser!.Id);
            
            if (provider != null)
            {
                query = query.Where(a => a.ProviderId == provider.Id);
            }
            else
            {
                appointments = new List<Appointment>();
                return;
            }
        }
        // Admins, Nurses, and Health Records see all appointments

        appointments = await query.ToListAsync();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Scheduled" => "bg-primary",
            "Confirmed" => "bg-success",
            "Cancelled" => "bg-danger",
            "Completed" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private void EditAppointment(int appointmentId)
    {
        // TODO: Navigate to edit page
        // NavigationManager.NavigateTo($"/appointments/edit/{appointmentId}");
    }

    private async Task CancelAppointment(int appointmentId)
    {
        var appointment = await DbContext.Appointments.FindAsync(appointmentId);
        if (appointment != null && appointment.Status != "Cancelled")
        {
            appointment.Status = "Cancelled";
            appointment.CancelledAt = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            await LoadAppointments();
            StateHasChanged();
        }
    }

}

