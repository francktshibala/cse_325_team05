@page "/appointments/{AppointmentId:int}/visit-notes"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using ClinicQueueSystem.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthorizationService AuthService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Visit Notes - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!canEditNotes)
    {
        <div class="alert alert-warning">
            You do not have permission to create or edit visit notes.
        </div>
    }
    else if (appointment == null || visit == null || currentProvider == null)
    {
        <div class="alert alert-danger">
            Unable to load appointment or visit context.
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success" role="alert">
                @successMessage
            </div>
        }

        <div class="card mb-4">
            <div class="card-header" style="background-color: #2C5F8D; color: white;">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">Visit Notes</h3>
                    <div class="text-end">
                        <div style="font-size: 0.9rem;">
                            <strong>Patient:</strong> @appointment.Patient.User.FirstName @appointment.Patient.User.LastName
                            <span class="mx-2">|</span>
                            <strong>Appt:</strong> @appointment.ScheduledDateTime.ToString("MMM dd, yyyy h:mm tt")
                            <span class="mx-2">|</span>
                            <strong>Provider:</strong> @currentProvider.User.FirstName @currentProvider.User.LastName
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center gap-2">
                    <label class="form-label mb-0 me-2"><strong>Note Type</strong></label>
                    <select class="form-select" style="max-width: 220px;" @bind="selectedNoteType" @bind:after="OnNoteTypeChanged">
                        <option value="General">General</option>
                        <option value="Diagnosis">Diagnosis</option>
                        <option value="Treatment">Treatment</option>
                        <option value="Prescription">Prescription</option>
                    </select>
                    <span class="ms-auto">
                        @if (isSaving)
                        {
                            <span class="text-muted">Saving…</span>
                        }
                        else if (lastSavedAt.HasValue)
                        {
                            <span class="text-success">Saved @lastSavedAt.Value.ToLocalTime().ToString("h:mm:ss tt")</span>
                        }
                    </span>
                </div>
                <textarea class="form-control" style="min-height: 260px;"
                          placeholder="Type visit notes here…"
                          @bind="noteText" @bind:event="oninput" @bind:after="OnNoteChanged"></textarea>
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-primary" @onclick="SaveNote" disabled="@isSaving">Save</button>
                    <a class="btn btn-secondary" href="/appointments">Back to Appointments</a>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Notes History</h5>
            </div>
            <div class="card-body">
                @if (notesHistory?.Any() != true)
                {
                    <div class="text-muted">No notes yet for this visit.</div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var n in notesHistory)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div>
                                            <strong>@n.NoteType</strong> by @n.Provider.User.FirstName @n.Provider.User.LastName
                                        </div>
                                        <small class="text-muted">
                                            @n.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy h:mm tt")
                                            @if (n.UpdatedAt.HasValue)
                                            {
                                                <text>(updated @n.UpdatedAt.Value.ToLocalTime().ToString("MMM dd, yyyy h:mm tt"))</text>
                                            }
                                        </small>
                                    </div>
                                    <span class="badge bg-secondary">@((n.NoteText?.Length ?? 0)) chars</span>
                                </div>
                                <div class="mt-2" style="white-space: pre-wrap;">@n.NoteText</div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int AppointmentId { get; set; }

    private Appointment? appointment;
    private Visit? visit;
    private Provider? currentProvider;
    private List<VisitNote> notesHistory = new();

    private bool loading = true;
    private bool canEditNotes = false;
    private string errorMessage = "";
    private string successMessage = "";

    private string selectedNoteType = "General";
    private string noteText = "";
    private bool isSaving = false;
    private DateTime? lastSavedAt;

    private System.Timers.Timer? debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        var canCreate = await AuthService.HasPermissionAsync(Permissions.VisitNotes_Create);
        var canEdit = await AuthService.HasPermissionAsync(Permissions.VisitNotes_Edit);
        canEditNotes = canCreate || canEdit;

        if (!canEditNotes)
        {
            loading = false;
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user == null)
        {
            loading = false;
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        // Get current provider (doctor/nurse user must map to Provider)
        currentProvider = await db.Providers
            .Include(p => p.User)
            .FirstOrDefaultAsync(p => p.UserId == user.Id);

        // Load appointment with patient/provider
        appointment = await db.Appointments
            .Include(a => a.Patient).ThenInclude(p => p.User)
            .Include(a => a.Provider).ThenInclude(p => p.User)
            .Include(a => a.Visit)
            .FirstOrDefaultAsync(a => a.Id == AppointmentId);

        if (appointment == null)
        {
            loading = false;
            errorMessage = "Appointment not found.";
            return;
        }

        // Ensure visit exists
        if (appointment.Visit == null)
        {
            visit = new Visit
            {
                PatientId = appointment.PatientId,
                AppointmentId = appointment.Id,
                StartTime = DateTime.UtcNow,
                Status = "InProgress"
            };
            db.Visits.Add(visit);
            await db.SaveChangesAsync();
            // Attach visit to appointment entity
            appointment.Visit = visit;
        }
        else
        {
            visit = appointment.Visit;
        }

        await LoadNotesHistory();

        // Prime editor with any existing note for this provider and selected type
        await LoadEditorBufferForCurrentSelection();

        loading = false;
    }

    private async Task LoadNotesHistory()
    {
        if (visit == null) return;

        await using var db = await DbFactory.CreateDbContextAsync();
        notesHistory = await db.VisitNotes
            .Where(vn => vn.VisitId == visit.Id)
            .Include(vn => vn.Provider).ThenInclude(p => p.User)
            .OrderByDescending(vn => vn.CreatedAt)
            .ToListAsync();
    }

    private async Task LoadEditorBufferForCurrentSelection()
    {
        if (visit == null || currentProvider == null) return;
        await using var db = await DbFactory.CreateDbContextAsync();
        var existing = await db.VisitNotes
            .Where(vn => vn.VisitId == visit.Id && vn.ProviderId == currentProvider.Id && vn.NoteType == selectedNoteType)
            .OrderByDescending(vn => vn.UpdatedAt ?? vn.CreatedAt)
            .FirstOrDefaultAsync();

        noteText = existing?.NoteText ?? "";
        StateHasChanged();
    }

    private void OnNoteChanged() => DebounceSave();

    private void DebounceSave()
    {
        // Initialize or reset 1s debounce timer
        if (debounceTimer == null)
        {
            debounceTimer = new System.Timers.Timer(1000);
            debounceTimer.AutoReset = false;
            debounceTimer.Elapsed += async (_, __) =>
            {
                await InvokeAsync(async () => { await SaveNote(); });
            };
        }
        else
        {
            debounceTimer.Stop();
        }
        debounceTimer.Start();
    }

    private async Task SaveNote()
    {
        if (visit == null || currentProvider == null) return;
        try
        {
            isSaving = true;
            StateHasChanged();

            await using var db = await DbFactory.CreateDbContextAsync();
            var existing = await db.VisitNotes
                .FirstOrDefaultAsync(vn => vn.VisitId == visit.Id && vn.ProviderId == currentProvider.Id && vn.NoteType == selectedNoteType);

            if (existing == null)
            {
                existing = new VisitNote
                {
                    VisitId = visit.Id,
                    ProviderId = currentProvider.Id,
                    NoteType = selectedNoteType,
                    NoteText = noteText,
                    CreatedAt = DateTime.UtcNow
                };
                db.VisitNotes.Add(existing);
            }
            else
            {
                existing.NoteText = noteText;
                existing.UpdatedAt = DateTime.UtcNow;
                db.VisitNotes.Update(existing);
            }

            await db.SaveChangesAsync();
            lastSavedAt = DateTime.UtcNow;
            successMessage = "";
            errorMessage = "";

            // Reload history list
            await LoadNotesHistory();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving note: {ex.Message}";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task OnNoteTypeChanged()
    {
        await LoadEditorBufferForCurrentSelection();
    }
}

