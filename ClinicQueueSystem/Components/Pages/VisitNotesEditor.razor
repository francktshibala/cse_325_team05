@page "/visits/{VisitId:int}/notes"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@inject ApplicationDbContext Db
@inject ClinicQueueSystem.Services.AuthorizationService AuthService
@inject UserManager<ApplicationUser> UserManager
@inject IHttpContextAccessor Http
@inject NavigationManager Navigation

<PageTitle>Visit Notes Editor - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
	<h2 class="mb-3" style="color: #2C5F8D;">Visit Notes Editor</h2>

	@if (!string.IsNullOrEmpty(errorMessage))
	{
		<div class="alert alert-danger">@errorMessage</div>
	}
	@if (!canView)
	{
		<div class="alert alert-warning">You do not have permission to view visit notes.</div>
	}
	else if (loading)
	{
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
		</div>
	}
	else if (visit is null)
	{
		<div class="alert alert-danger">Visit not found.</div>
	}
	else
	{
		<div class="card mb-3">
			<div class="card-body d-flex align-items-center justify-content-between">
				<div>
					<div class="fw-semibold">Patient: @visit.Patient.User.FirstName @visit.Patient.User.LastName</div>
					<div class="text-muted">Visit: @visit.StartTime.ToLocalTime().ToString("f")</div>
				</div>
				<div class="d-flex gap-2">
					<a class="btn btn-secondary" href="/patients/@visit.PatientId">Back to Patient</a>
					<a class="btn btn-outline-primary" href="/patients/@visit.PatientId/visits">Visit History</a>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-md-4">
				<div class="card">
					<div class="card-header">
						<h3 class="card-title">Notes</h3>
					</div>
					<div class="card-body">
						<button class="btn btn-primary mb-3" disabled="@(!canCreate)" @onclick="CreateNewDraft">New Note</button>
						@if (notes.Count == 0)
						{
							<div class="text-muted">No notes yet.</div>
						}
						else
						{
							<ul class="list-group">
								@foreach (var n in notes)
								{
									<li class="list-group-item d-flex justify-content-between align-items-center @(selectedNoteId == n.Id ? "active" : "")" role="button" @onclick="() => SelectNote(n.Id)">
										<span>
											<span class="badge bg-secondary me-2">@n.NoteType</span>
											@((n.UpdatedAt ?? n.CreatedAt).ToLocalTime().ToString("g"))
										</span>
										@if (selectedNoteId == n.Id)
										{
											<span class="badge bg-light text-dark">Selected</span>
										}
									</li>
								}
							</ul>
						}
					</div>
				</div>
			</div>
			<div class="col-md-8">
				<div class="card">
					<div class="card-header d-flex align-items-center justify-content-between">
						<h3 class="card-title mb-0">Editor</h3>
						<div class="text-muted">
							@if (isSaving) { <span>Savingâ€¦</span> }
							else if (lastSavedAt.HasValue) { <span>Saved @lastSavedAt.Value.ToLocalTime().ToString("T")</span> }
						</div>
					</div>
					<div class="card-body">
						@if (selected == null)
						{
							<div class="alert alert-info">Select a note to edit, or create a new one.</div>
						}
						else
						{
							<div class="row">
								<div class="col-md-6">
									<div class="form-group mb-3">
										<label class="form-label">Note Type</label>
										<select class="form-select" @bind="selected.NoteType" @bind:after="OnEditorChanged" disabled="@(!canEdit)">
											<option>General</option>
											<option>Diagnosis</option>
											<option>Treatment</option>
											<option>Prescription</option>
										</select>
									</div>
								</div>
							</div>
							<div class="form-group mb-3">
								<label class="form-label">Note Text</label>
								<textarea class="form-control" rows="12" @bind="selected.NoteText" @bind:event="oninput" @bind:after="OnEditorChanged" disabled="@(!canEdit)"></textarea>
							</div>
							<div class="d-flex gap-2">
								<button class="btn btn-primary" @onclick="SaveAsync" disabled="@(!canEdit || !isDirty || isSaving)">Save</button>
								<button class="btn btn-secondary" @onclick="DiscardChanges" disabled="@(!isDirty || isSaving)">Discard</button>
							</div>
						}
					</div>
				</div>
			</div>
		</div>
	}
</div>

@code {
	[Microsoft.AspNetCore.Components.Parameter] public int VisitId { get; set; }

	private bool loading = true;
	private bool canView = false;
	private bool canCreate = false;
	private bool canEdit = false;
	private string errorMessage = string.Empty;

	private Visit? visit;
	private List<VisitNote> notes = new();
	private int? selectedNoteId;
	private VisitNote? selected;

	private bool isDirty = false;
	private bool isSaving = false;
	private DateTime? lastSavedAt;
	private System.Threading.CancellationTokenSource? autosaveCts;

	protected override async Task OnInitializedAsync()
	{
		canView = await AuthService.HasPermissionAsync(Permissions.VisitNotes_View);
		canCreate = await AuthService.HasPermissionAsync(Permissions.VisitNotes_Create);
		canEdit = await AuthService.HasPermissionAsync(Permissions.VisitNotes_Edit);
		await LoadAsync();
	}

	private async Task LoadAsync()
	{
		if (!canView)
		{
			loading = false;
			return;
		}
		loading = true;
		visit = await Db.Visits
			.Include(v => v.Patient).ThenInclude(p => p.User)
			.FirstOrDefaultAsync(v => v.Id == VisitId);
		if (visit != null)
		{
			notes = await Db.VisitNotes
				.Where(n => n.VisitId == visit.Id)
				.OrderByDescending(n => n.UpdatedAt ?? n.CreatedAt)
				.ToListAsync();
			selectedNoteId = notes.FirstOrDefault()?.Id;
			selected = notes.FirstOrDefault();
		}
		loading = false;
		StateHasChanged();
	}

	private async Task<int?> GetCurrentProviderIdAsync()
	{
		var user = await UserManager.GetUserAsync(Http.HttpContext!.User);
		if (user == null) return null;
		var provider = await Db.Providers.FirstOrDefaultAsync(p => p.UserId == user.Id);
		return provider?.Id;
	}

	private void SelectNote(int id)
	{
		if (isSaving) return;
		selectedNoteId = id;
		selected = notes.First(n => n.Id == id);
		isDirty = false;
	}

	private async Task CreateNewDraft()
	{
		if (!canCreate) return;
		var providerId = await GetCurrentProviderIdAsync();
		if (providerId is null)
		{
			errorMessage = "Your account is not linked to a provider profile.";
			return;
		}
		var note = new VisitNote
		{
			VisitId = VisitId,
			ProviderId = providerId.Value,
			NoteType = "General",
			NoteText = string.Empty,
			CreatedAt = DateTime.UtcNow
		};
		Db.VisitNotes.Add(note);
		await Db.SaveChangesAsync();
		notes.Insert(0, note);
		SelectNote(note.Id);
	}

	private void OnEditorChanged()
	{
		isDirty = true;
		TriggerAutosave();
	}

	private void TriggerAutosave()
	{
		if (!canEdit || selected is null) return;
		autosaveCts?.Cancel();
		autosaveCts = new System.Threading.CancellationTokenSource();
		var token = autosaveCts.Token;
		_ = Task.Run(async () =>
		{
			try
			{
				await Task.Delay(1500, token);
				if (token.IsCancellationRequested) return;
				await InvokeAsync(SaveAsync);
			}
			catch (TaskCanceledException) { }
		}, token);
	}

	private async Task SaveAsync()
	{
		if (!isDirty || selected is null) return;
		try
		{
			isSaving = true;
			selected.UpdatedAt = DateTime.UtcNow;
			await Db.SaveChangesAsync();
			lastSavedAt = DateTime.UtcNow;
			isDirty = false;
		}
		catch (Exception ex)
		{
			errorMessage = $"Failed to save: {ex.Message}";
		}
		finally
		{
			isSaving = false;
		}
	}

	private void DiscardChanges()
	{
		if (selected is null || selectedNoteId is null) return;
		var dbCopy = notes.First(n => n.Id == selectedNoteId.Value);
		selected.NoteText = dbCopy.NoteText;
		selected.NoteType = dbCopy.NoteType;
		isDirty = false;
	}
}


