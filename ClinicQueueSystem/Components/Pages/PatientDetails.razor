@page "/patients/{Id:int}"
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using ClinicQueueSystem.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject AuthorizationService AuthService
@attribute [Authorize]
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

<PageTitle>Patient Details - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (patient == null)
    {
        <div class="alert alert-warning">
            Patient not found.
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success" role="alert">
                @successMessage
            </div>
        }

        <div class="card mb-4">
            <div class="card-header" style="background-color: #2C5F8D; color: white;">
                <h3 class="card-title mb-0">
                    @patient.User.FirstName @patient.User.LastName
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <p><strong>Medical Record Number:</strong> @patient.MedicalRecordNumber</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Date of Birth:</strong> @patient.DateOfBirth.ToString("MMMM dd, yyyy")</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Gender:</strong> @patient.Gender</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Phone:</strong> @patient.PhoneNumber</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Email:</strong> @patient.User.Email</p>
                    </div>
                    <div class="col-md-12 mb-3">
                        <p><strong>Address:</strong> @patient.Address</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Emergency Contact:</strong> @patient.EmergencyContact</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>Emergency Phone:</strong> @patient.EmergencyPhone</p>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="d-flex gap-2 flex-wrap">
                    @if (canEditPatients)
                    {
                        <a href="/patients/edit/@patient.Id" class="btn btn-primary">
                            <span class="bi bi-pencil me-1"></span>
                            Edit Patient
                        </a>
                    }
                    <a href="/patients" class="btn btn-secondary">
                        <span class="bi bi-arrow-left me-1"></span>
                        Back to List
                    </a>
                    @if (canDeletePatients)
                    {
                        <button class="btn btn-danger ms-auto" @onclick="ShowDeleteConfirmation" disabled="@isDeleting">
                            @if (isDeleting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            else
                            {
                                <span class="bi bi-trash me-1"></span>
                            }
                            Delete Patient
                        </button>
                    }
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Visit History</h5>
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label mb-0 me-1">From</label>
                    <InputDate @bind-Value="historyFrom" class="form-control form-control-sm" />
                    <label class="form-label mb-0 ms-2 me-1">To</label>
                    <InputDate @bind-Value="historyTo" class="form-control form-control-sm" />
                    <input class="form-control form-control-sm ms-2" style="min-width: 240px;" placeholder="Search notes..." @bind="historySearch" @bind:event="oninput" />
                    <button class="btn btn-sm btn-outline-primary ms-2" @onclick="ApplyVisitFilters">Apply</button>
                </div>
            </div>
            <div class="card-body">
                @if (filteredVisits?.Any() != true)
                {
                    <div class="text-muted">No visits found.</div>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var v in filteredVisits)
                        {
                            var isOpen = expandedVisitIds.Contains(v.Id);
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div><strong>@v.StartTime.ToLocalTime().ToString("MMM dd, yyyy h:mm tt")</strong> â€” @v.Status</div>
                                        @if (!string.IsNullOrEmpty(v.Diagnosis))
                                        {
                                            <small class="text-muted">Dx: @v.Diagnosis</small>
                                        }
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ToggleVisitExpand(v.Id)">
                                        @(isOpen ? "Hide" : "View")
                                    </button>
                                </div>
                                @if (isOpen)
                                {
                                    <div class="mt-3">
                                        @if (v.Notes?.Any() == true)
                                        {
                                            @foreach (var n in v.Notes.OrderByDescending(n => n.CreatedAt))
                                            {
                                                <div class="mb-3 p-2 border rounded">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <strong>@n.NoteType</strong> by @n.Provider.User.FirstName @n.Provider.User.LastName
                                                        </div>
                                                        <small class="text-muted">@n.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy h:mm tt")</small>
                                                    </div>
                                                    <div class="mt-2" style="white-space: pre-wrap;">@n.NoteText</div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-muted">No notes recorded for this visit.</div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        @if (showDeleteModal)
        {
            <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete the patient record for <strong>@patient.User.FirstName @patient.User.LastName</strong>?</p>
                            <p class="text-danger"><strong>Warning:</strong> This action cannot be undone. All associated appointments, visits, and queue entries will be affected.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                            <button type="button" class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Patient? patient;
    private bool loading = true;
    private bool canEditPatients = false;
    private bool canDeletePatients = false;
    private bool isDeleting = false;
    private bool showDeleteModal = false;
    private string errorMessage = "";
    private string successMessage = "";

    // Visit history state
    private List<Visit> visits = new();
    private List<Visit> filteredVisits = new();
    private DateTime? historyFrom = null;
    private DateTime? historyTo = null;
    private string historySearch = string.Empty;
    private HashSet<int> expandedVisitIds = new();

    protected override async Task OnInitializedAsync()
    {
        canEditPatients = await AuthService.HasPermissionAsync(Permissions.Patients_Edit);
        // Only admins and health records staff can delete patients (same permission as edit for now)
        canDeletePatients = await AuthService.HasRoleAsync("Admin", "Health Records");

        await using var db = await DbFactory.CreateDbContextAsync();
        patient = await db.Patients
            .Include(p => p.User)
            .FirstOrDefaultAsync(p => p.Id == Id);

        if (patient != null)
        {
            visits = await db.Visits
                .Where(v => v.PatientId == patient.Id)
                .Include(v => v.Notes)
                    .ThenInclude(n => n.Provider)
                        .ThenInclude(pr => pr.User)
                .OrderByDescending(v => v.StartTime)
                .ToListAsync();
            ApplyVisitFilters();
        }

        loading = false;
    }

    private void ApplyVisitFilters()
    {
        IEnumerable<Visit> q = visits;
        if (historyFrom.HasValue)
        {
            q = q.Where(v => v.StartTime.Date >= historyFrom.Value.Date);
        }
        if (historyTo.HasValue)
        {
            q = q.Where(v => v.StartTime.Date <= historyTo.Value.Date);
        }
        if (!string.IsNullOrWhiteSpace(historySearch))
        {
            var s = historySearch.Trim();
            q = q.Where(v => v.Notes.Any(n =>
                (n.NoteText != null && n.NoteText.Contains(s, StringComparison.OrdinalIgnoreCase)) ||
                (n.NoteType != null && n.NoteType.Contains(s, StringComparison.OrdinalIgnoreCase))));
        }
        filteredVisits = q
            .OrderByDescending(v => v.StartTime)
            .ToList();
    }

    private void ToggleVisitExpand(int visitId)
    {
        if (expandedVisitIds.Contains(visitId))
        {
            expandedVisitIds.Remove(visitId);
        }
        else
        {
            expandedVisitIds.Add(visitId);
        }
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteModal = true;
    }

    private void CancelDelete()
    {
        showDeleteModal = false;
    }

    private async Task ConfirmDelete()
    {
        if (patient == null) return;

        showDeleteModal = false;
        isDeleting = true;
        errorMessage = "";

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            // Note: This will only work if there are no dependent records (appointments, visits, etc.)
            // You might need to handle cascading deletes or prevent deletion if there are dependencies
            db.Patients.Remove(patient);
            await db.SaveChangesAsync();
            Navigation.NavigateTo("/patients");
        }
        catch (DbUpdateException)
        {
            errorMessage = "Cannot delete patient. This patient has associated appointments or visits. Please remove those first.";
            isDeleting = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting patient: {ex.Message}";
            isDeleting = false;
        }
    }
}
