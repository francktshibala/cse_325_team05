@page "/patients/edit/{Id:int}"
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using ClinicQueueSystem.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject NavigationManager Navigation
@inject AuthorizationService AuthService
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Edit Patient - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    @if (!canEditPatients)
    {
        <div class="alert alert-warning">
            You do not have permission to edit patients.
        </div>
    }
    else if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (patient == null)
    {
        <div class="alert alert-warning">Patient not found.</div>
    }
    else
    {
        <h2 style="color: #2C5F8D; margin-bottom: 1rem;">Edit Patient</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                @errorMessage
            </div>
        }

        <EditForm Model="patient" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label class="form-label">First Name</label>
                <InputText class="form-control" @bind-Value="patient.User.FirstName" />
            </div>

            <div class="form-group">
                <label class="form-label">Last Name</label>
                <InputText class="form-control" @bind-Value="patient.User.LastName" />
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <InputText type="email" class="form-control" @bind-Value="patient.User.Email" />
            </div>

            <div class="form-group">
                <label class="form-label">Medical Record Number</label>
                <InputText class="form-control" @bind-Value="patient.MedicalRecordNumber" />
            </div>

            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <InputText class="form-control" @bind-Value="patient.PhoneNumber" />
            </div>

            <div class="form-group">
                <label class="form-label">Date of Birth</label>
                <InputDate class="form-control" @bind-Value="patient.DateOfBirth" />
            </div>

            <div class="form-group">
                <label class="form-label">Gender</label>
                <InputText class="form-control" @bind-Value="patient.Gender" />
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <InputText class="form-control" @bind-Value="patient.Address" />
            </div>

            <div class="form-group">
                <label class="form-label">Emergency Contact</label>
                <InputText class="form-control" @bind-Value="patient.EmergencyContact" />
            </div>

            <div class="form-group">
                <label class="form-label">Emergency Phone</label>
                <InputText class="form-control" @bind-Value="patient.EmergencyPhone" />
            </div>

            <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                    @if (isProcessing)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    Save Changes
                </button>
                <a href="/patients" class="btn btn-secondary">Cancel</a>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Patient? patient;
    private bool loading = true;
    private bool canEditPatients = false;
    private bool isProcessing = false;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        canEditPatients = await AuthService.HasPermissionAsync(Permissions.Patients_Edit);

        if (canEditPatients)
        {
            patient = await Db.Patients
                .Include(p => p.User)
                .FirstOrDefaultAsync(p => p.Id == Id);
        }

        loading = false;
    }

    private async Task HandleValidSubmit()
    {
        if (patient == null) return;

        errorMessage = "";
        isProcessing = true;

        try
        {
            Db.Patients.Update(patient);
            await Db.SaveChangesAsync();
            Navigation.NavigateTo("/patients");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating patient: {ex.Message}";
            isProcessing = false;
        }
    }
}
