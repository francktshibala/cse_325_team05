@page "/checkin"
@using ClinicQueueSystem.Data
@using ClinicQueueSystem.Data.Models
@using ClinicQueueSystem.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Check In - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 style="color: #2C5F8D; font-weight: 700;">Check In</h1>
            <p class="text-muted">Enter your appointment details to check in</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    @if (hasActiveQueueTicket)
    {
        <div class="alert alert-info">
            <h5>You are already checked in</h5>
            <p>
                Your Position: #@activeTicket.QueuePosition<br />
                Status: @activeTicket.Status<br />
                Estimated Wait: @CalculateWaitTime(activeTicket.QueuePosition) minutes
            </p>
            <button class="btn btn-outline-danger" @onclick="CancelCheckIn">Cancel Check-In</button>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Appointment ID or Patient Name</label>
                <input type="text" class="form-control" @bind="appointmentInput" placeholder="Enter ID or Name" />
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button class="btn btn-primary" @onclick="CheckInAppointment">Check In</button>
            </div>
        </div>
    }
</div>

@code {
    private string appointmentInput = string.Empty;
    private string errorMessage = string.Empty;
    private bool hasActiveQueueTicket = false;
    private QueueTicket? activeTicket;
    private Patient? currentPatient;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
            return;

        currentPatient = await DbContext.Patients
            .Include(p => p.User)
            .FirstOrDefaultAsync(p => p.User.UserName == user.Identity.Name);

        if (currentPatient == null)
            return;

        // Check if already in queue
        activeTicket = await DbContext.QueueTickets
            .FirstOrDefaultAsync(q => q.PatientId == currentPatient.Id && q.Status != "Completed");

        hasActiveQueueTicket = activeTicket != null;
    }

    private async Task CheckInAppointment()
    {
        errorMessage = string.Empty;

        if (currentPatient == null)
        {
            errorMessage = "Patient not found.";
            return;
        }

        // Try to find appointment by ID
        Appointment? appointment = null;
        if (int.TryParse(appointmentInput, out int appointmentId))
        {
            appointment = await DbContext.Appointments
                .FirstOrDefaultAsync(a => a.Id == appointmentId && a.PatientId == currentPatient.Id);
        }
        else
        {
            // Search by patient name (first or last)
            appointment = await DbContext.Appointments
                .Include(a => a.Patient)
                .ThenInclude(p => p.User)
                .Where(a => a.PatientId == currentPatient.Id &&
                            (a.Patient.User.FirstName.Contains(appointmentInput) ||
                             a.Patient.User.LastName.Contains(appointmentInput)))
                .FirstOrDefaultAsync();
        }

        if (appointment == null)
        {
            errorMessage = "Appointment not found.";
            return;
        }

        if (appointment.ScheduledDateTime.Date != DateTime.Today)
        {
            errorMessage = "Appointment is not scheduled for today.";
            return;
        }

        // Check if already in queue
        activeTicket = await DbContext.QueueTickets
            .FirstOrDefaultAsync(q => q.PatientId == currentPatient.Id && q.Status != "Completed");

        if (activeTicket != null)
        {
            hasActiveQueueTicket = true;
            StateHasChanged();
            return;
        }

        // Create new queue ticket
        var lastPosition = await DbContext.QueueTickets
            .Where(q => q.Status != "Completed")
            .MaxAsync(q => (int?)q.QueuePosition) ?? 0;

        activeTicket = new QueueTicket
        {
            PatientId = currentPatient.Id,
            AppointmentId = appointment.Id,
            QueuePosition = lastPosition + 1,
            Status = "Waiting",
            CheckInTime = DateTime.UtcNow,
            Priority = 1 // Normal priority, you can adjust
        };

        DbContext.QueueTickets.Add(activeTicket);
        await DbContext.SaveChangesAsync();

        hasActiveQueueTicket = true;
        StateHasChanged();
    }

    private async Task CancelCheckIn()
    {
        if (currentPatient == null || activeTicket == null) return;

        activeTicket.Status = "Completed";
        activeTicket.CompletedTime = DateTime.UtcNow;

        await DbContext.SaveChangesAsync();

        hasActiveQueueTicket = false;
        activeTicket = null;
        StateHasChanged();
    }

    private int CalculateWaitTime(int position)
    {
        // Simple calculation: 15 minutes per person ahead
        return (position - 1) * 15;
    }
}
