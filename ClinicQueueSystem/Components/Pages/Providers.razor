@page "/providers"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Microsoft.EntityFrameworkCore
@using ClinicQueueSystem.Data
@inject ApplicationDbContext Db
@inject ClinicQueueSystem.Services.AuthorizationService AuthService
@inject Microsoft.AspNetCore.Identity.UserManager<ApplicationUser> UserManager

<PageTitle>Providers - Clinic Queue System</PageTitle>

<div class="container" style="padding: 2rem 0;">
    <h2 class="mb-3" style="color: #2C5F8D;">Providers</h2>

	@if (!string.IsNullOrEmpty(errorMessage))
	{
		<div class="alert alert-danger">@errorMessage</div>
	}

    @if (!canView)
    {
        <div class="alert alert-warning">You do not have permission to view providers.</div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex gap-2">
                <input class="form-control" style="max-width: 280px;" placeholder="Search name or email" @bind="search" />
                <select class="form-control" style="max-width: 160px;" @bind="statusFilter">
                    <option value="all">All</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <button class="btn btn-outline-primary" @onclick="LoadAsync">Apply</button>
            </div>
			@if (canCreate)
			{
				<a href="/providers/create" class="btn btn-primary">
					<span class="bi bi-plus-circle me-1"></span>
					Create Provider
				</a>
			}
        </div>

        @if (loading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (items.Count == 0)
        {
            <div class="alert alert-info">No providers found.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th style="white-space: nowrap;">Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Specialty</th>
                            <th>License</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in items)
                        {
                            <tr>
                                <td style="white-space: nowrap;">@p.User.FirstName @p.User.LastName</td>
                                <td>@p.User.Email</td>
                                <td>@p.ProviderType</td>
                                <td>@p.Specialty</td>
                                <td>@p.LicenseNumber</td>
                                <td>
                                    <span class="badge @(p.IsActive ? "bg-success" : "bg-secondary")">@(p.IsActive ? "Active" : "Inactive")</span>
                                </td>
                                <td class="text-end" style="white-space: nowrap;">
									<a class="btn btn-sm btn-outline-primary me-1" href="/providers/@p.Id" disabled="@(!canView)">Details</a>
									<a class="btn btn-sm btn-outline-primary me-1" href="/providers/edit/@p.Id" disabled="@(!canEdit)">Edit</a>
									<button class="btn btn-sm @(p.IsActive ? "btn-outline-secondary" : "btn-outline-success") me-1" disabled="@(!canEdit)" @onclick="() => ToggleActiveAsync(p.Id, !p.IsActive)">
                                        @(p.IsActive ? "Deactivate" : "Activate")
                                    </button>
									<button class="btn btn-sm btn-outline-danger" disabled="@(!canDelete)" @onclick="() => RequestDelete(p.Id)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
			@if (confirmDeleteId.HasValue)
			{
				<div class="alert alert-warning d-flex justify-content-between align-items-center">
					<div>Are you sure you want to delete this provider? This will remove the user account if possible.</div>
					<div class="d-flex gap-2">
						<button class="btn btn-danger btn-sm" @onclick="ConfirmDeleteAsync">Yes, delete</button>
						<button class="btn btn-secondary btn-sm" @onclick="() => confirmDeleteId = null">Cancel</button>
					</div>
				</div>
			}
        }
    }
</div>

@code {
    private bool loading = true;
    private bool canView = false;
    private bool canEdit = false;
	private bool canCreate = false;
	private bool canDelete = false;
    private string search = string.Empty;
    private string statusFilter = "all";
    private List<Provider> items = new();
	private string errorMessage = string.Empty;
	private int? confirmDeleteId = null;

    protected override async Task OnInitializedAsync()
    {
        canView = await AuthService.HasPermissionAsync(Permissions.Users_View);
        canEdit = await AuthService.HasPermissionAsync(Permissions.Users_Edit);
		canCreate = await AuthService.HasPermissionAsync(Permissions.Users_Create);
		canDelete = await AuthService.HasPermissionAsync(Permissions.Users_Delete);
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        if (!canView)
        {
            loading = false;
            return;
        }
        loading = true;
        StateHasChanged();

        var q = Db.Providers
            .Include(p => p.User)
            .OrderBy(p => p.User.LastName).ThenBy(p => p.User.FirstName)
            .AsQueryable();

        if (!string.IsNullOrWhiteSpace(search))
        {
            var term = search.Trim().ToLower();
            q = q.Where(p => p.User.FirstName.ToLower().Contains(term)
                || p.User.LastName.ToLower().Contains(term)
                || (p.User.Email ?? string.Empty).ToLower().Contains(term));
        }
        if (statusFilter == "active")
        {
            q = q.Where(p => p.IsActive);
        }
        else if (statusFilter == "inactive")
        {
            q = q.Where(p => !p.IsActive);
        }

        items = await q.ToListAsync();
        loading = false;
    }

	private void RequestDelete(int id)
	{
		if (!canDelete) return;
		confirmDeleteId = id;
	}

	private async Task ConfirmDeleteAsync()
	{
		errorMessage = string.Empty;
		if (!canDelete || confirmDeleteId is null)
		{
			confirmDeleteId = null;
			return;
		}
		try
		{
			// Ensure no related data that blocks deletion
			var provider = await Db.Providers.Include(p => p.User)
				.Include(p => p.Appointments)
				.Include(p => p.Schedules)
				.Include(p => p.VisitNotes)
				.FirstOrDefaultAsync(p => p.Id == confirmDeleteId.Value);
			if (provider is null)
			{
				confirmDeleteId = null;
				return;
			}
			var hasBlockingRelations = provider.Appointments.Any() || provider.Schedules.Any() || provider.VisitNotes.Any();
			if (hasBlockingRelations)
			{
				errorMessage = "Cannot delete provider with related appointments, schedules, or visit notes. Deactivate instead.";
				confirmDeleteId = null;
				return;
			}
			// Delete the underlying user; provider will cascade
			var user = provider.User;
			var res = await UserManager.DeleteAsync(user);
			if (!res.Succeeded)
			{
				errorMessage = string.Join("; ", res.Errors.Select(e => e.Description));
			}
			await LoadAsync();
		}
		catch (Exception ex)
		{
			errorMessage = $"Error deleting provider: {ex.Message}";
		}
		finally
		{
			confirmDeleteId = null;
		}
	}

    private async Task ToggleActiveAsync(int providerId, bool newValue)
    {
        if (!canEdit)
        {
            return;
        }
        var provider = await Db.Providers.FirstOrDefaultAsync(p => p.Id == providerId);
        if (provider == null)
        {
            return;
        }
        provider.IsActive = newValue;
        await Db.SaveChangesAsync();
        await LoadAsync();
    }
}


